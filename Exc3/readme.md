# Список проблем и рисков, которые связаны с планируемым ростом нагрузки

Для следующих интегрций характер взаимодействия "2"точка-точка", осуществляемый синхронным способом:

core-app <-> ins-product-aggregator <-> api-insurance-company (5) (см [диаграмма 1](./d/d01.puml))

ins-comp-settlement <-> ins-product-aggregator <-> api-insurance-company (5) (см [диаграмма 2](./d/d02.puml))

Данная архитектура приводит к ряду рисков и проблем:

1. Риск недоступности одного или нескольких API информационных систем страховых компаний, что приводит к ошибке 
   исполнения изначального запроса (см [диаграмма 3](./d/d03.puml))
2. Риск возможного таймаута (или превышения периода запроса в 15 мин) из-за долгого ответ от API, либо долгой 
   обработке данных в ins-product-aggregator (см [диаграмма 4](./d/d04.puml))
3. Возможен конфликт одновременного синхронного запроса ins-comp-settlement <-> ins-product-aggregator и core-app <->
   ins-product-aggregator (см [диаграмма 5](./d/d05.puml))
4. Риски 1-2 особенно критичны для ins-comp-settlement <-> ins-product-aggregator <-> api-insurance-company так как
   запрос происходит всего лишь 1 раз в сутки
5. По мере роста страховых компаний, с которыми происходит интеграции, увеличивается и количество запросов в рамках 
   синхронного запроса, что повышает вероятность возникновения рисков 1-3.

# Решение проблем и минимазации рисков

Переход на event-driven архитектуру решит выше приведенные проблемы и минимизирует риски.

## Изменения в архитектуре

1. Изменить ins-product-aggregator так, чтобы он самостоятельно регулярно опрашивал api-insurance-company. 
2. Добавить базу данных product-aggregator-db для хранения данных, поступивших от api-insurance-company.
3. Реализовать сравнение поступающих от api-insurance-company данных с данными, хранящимися в product-aggregator-db для 
   генерации собитий (см ниже раздел События)
4. Изменить характер взаимодействия core-app <-> ins-product-aggregator и ins-comp-settlement <-> 
   ins-product-aggregator на "публикация-подписка", добавив брокер сообщений (см схема) и применяя паттерн 
   Transactional outbox, так как в архитектуре to-be есть ситуация, при которой происходит и запись в 
   product-aggregator-db и публикация сообщения в брокер. (см [диаграмма 6](./d/d06.puml))

## События

В результате стравнения данных, поступившие от api-insurance-company с данными, хранящимися в product-aggregator-db 
могут возникнуть события:

1. Добавление нового продукта
2. Изменение существующего продукта
3. Исключение существующего продукта
4. Добавление нового тарифа
5. Изменение существующего тарифа
6. Исключение существующего тарифа

